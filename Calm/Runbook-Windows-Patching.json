{"status":{},"contains_secrets":false,"product_version":"3.2.6","spec":{"description":"Installs Tools Needed to patch a server, reports pending patches and installs","resources":{"endpoints_information":[],"endpoint_definition_list":[],"credential_definition_list":[],"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Loop till no Windows update"}],"name":"604c2941_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"cf75865a_1_META"}],"name":"Loop till no Windows update","attrs":{"loop_variable":"iteration","exit_condition_type":"dont_care","type":"","iterations":"10"},"timeout_secs":"0","type":"WHILE_LOOP","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Check if any update or not"}],"name":"cf75865a_1_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Check if any update or not","attrs":{"failure_child_reference":{"kind":"app_task","name":"2d4c44fd_FAILURE_META"},"exit_status":[],"script":"$updates = Get-WindowsUpdate\nif ($updates) {\n  write $updates;\n  write-error \"lets install this\"\n}","success_child_reference":{"kind":"app_task","name":"23b72f7f_SUCCESS_META"},"type":"","command_line_args":"","script_type":"npsscript"},"timeout_secs":"0","type":"DECISION","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Wait 60sec before next loop"},{"kind":"app_task","name":"No update"}],"name":"23b72f7f_SUCCESS_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Wait 60sec before next loop","attrs":{"type":"","interval_secs":60},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"No update","attrs":{"script":"write \"There's no update to apply!\"","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Loop till one bunch of update applied"}],"name":"2d4c44fd_FAILURE_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"8b02ea80_1_META"}],"name":"Loop till one bunch of update applied","attrs":{"loop_variable":"iteration","exit_condition_type":"on_success","type":"","iterations":"5"},"timeout_secs":"0","type":"WHILE_LOOP","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Start installing update"},{"kind":"app_task","name":"Sleep 10min for installation"},{"kind":"app_task","name":"Check if update is finished or not after 10min"}],"name":"8b02ea80_1_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Start installing update","attrs":{"script":"write \"Installing the following updates.\"\nget-windowsupdate\n$task = get-scheduledtask \"Patching\" -ea:4\nif ($task.state -eq \"Ready\" -or !$task){\n  get-scheduledtask \"Patching\" -ea:4 | Unregister-scheduledtask -Confirm:0  -ea:4\n  write \"Creating Task\"\n  $taskname = \"Patching\"\n  [array]$script += 'start-transcript C:\\windows\\temp\\wu.log'\n  $script += 'write \"Adding MSUpdate Repository\"'\n  $script += 'Add-WUServiceManager -ServiceID 7971f918-a847-4430-9279-4a52d1efe18d -confirm:0'\n  $script += '$updates = Get-WindowsUpdate -MicrosoftUpdate'\n  $script += 'foreach ($update in $updates){'\n  $script += '  write \"Installing update $($Update.kb)\"'\n  $script += '  Install-WindowsUpdate -KBArticleID $update.KB -AcceptAll'\n  $script += '  write \"Installing update $($Update.kb) Completed\"'\n  $script += '}'\n  $script | out-file c:\\windows\\temp\\Psupdate.ps1 -encoding ascii\n  $taskdescription = \"Installing Windows Patches\"\n  $action = New-ScheduledTaskAction -Execute 'Powershell.exe' -Argument '-File c:\\windows\\temp\\Psupdate.ps1'\n  $trigger =  New-ScheduledTaskTrigger -AtStartup -RandomDelay (New-TimeSpan -minutes 3)\n  $settings = New-ScheduledTaskSettingsSet -ExecutionTimeLimit (New-TimeSpan -Minutes 45) -RestartCount 3 -RestartInterval (New-TimeSpan -Minutes 1)\n  \n  write \"Registering task\"\n\n  Register-ScheduledTask -Action $action -Trigger $trigger -TaskName $taskname -Description $taskdescription -Settings $settings -User \"System\"\n  sleep 5\n\n  write \"Starting task\"\n\n  Start-ScheduledTask $taskname\n\n  sleep 5\n\n  $task = get-scheduledtask \"Patching\"\n  \n\n} else {\n\n  write \"Were still Patching\"\n  \n  get-content C:\\windows\\temp\\wu.log\n}","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Sleep 10min for installation","attrs":{"type":"","interval_secs":600},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Check if update is finished or not after 10min","attrs":{"failure_child_reference":{"kind":"app_task","name":"cace7937_FAILURE_META"},"exit_status":[],"script":"$task = get-scheduledtask \"Patching\" -ea:4\nif ($task.state -eq \"Running\"){\n  write-error \"Still installing patches\"\n} else {\n  write \"Installing done\"\n}","success_child_reference":{"kind":"app_task","name":"3451062d_SUCCESS_META"},"type":"","command_line_args":"","script_type":"npsscript"},"timeout_secs":"0","type":"DECISION","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Check if reboot is required"}],"name":"3451062d_SUCCESS_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Check if reboot is required","attrs":{"failure_child_reference":{"kind":"app_task","name":"b12f0352_FAILURE_META"},"exit_status":[],"script":"get-scheduledtask \"RebootStatus\" -ea:4 | Unregister-scheduledtask -Confirm:0 -ea:4\nwrite \"Creating Task\"\n$taskname = \"RebootStatus\"\n$taskdescription = \"Installing Windows Patches\"\n$action = New-ScheduledTaskAction -Execute 'Powershell.exe' -Argument '-NoProfile -WindowStyle Hidden -command \"Get-WURebootStatus | out-file c:\\windows\\temp\\rebootstatus.log\"'\n$trigger =  New-ScheduledTaskTrigger -AtStartup -RandomDelay (New-TimeSpan -minutes 3)\n$settings = New-ScheduledTaskSettingsSet -ExecutionTimeLimit (New-TimeSpan -Minutes 2) -RestartCount 3 -RestartInterval (New-TimeSpan -Minutes 1)\n\nwrite \"Registering task\"\n\nRegister-ScheduledTask -Action $action -Trigger $trigger -TaskName $taskname -Description $taskdescription -Settings $settings -User \"System\"\nsleep 5\n\nwrite \"Starting task\"\n\nStart-ScheduledTask $taskname\n\nsleep 5\n\n$reboot = get-content \"c:\\windows\\temp\\rebootstatus.log\"\n\nif ($reboot -match \"Reboot is not Required.\"){\n  write-error \"Reboot is not required\"  \n} else {\n  write \"Reboot is required\"\n}\n\nremove-item \"c:\\windows\\temp\\rebootstatus.log\"","success_child_reference":{"kind":"app_task","name":"23492f5d_SUCCESS_META"},"type":"","command_line_args":"","script_type":"npsscript"},"timeout_secs":"0","type":"DECISION","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Start rebooting"},{"kind":"app_task","name":"Sleep 10min for reboot"},{"kind":"app_task","name":"Finish the iteraton with reboot"}],"name":"23492f5d_SUCCESS_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Start rebooting","attrs":{"script":"shutdown -r -t 10","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Sleep 10min for reboot","attrs":{"type":"","interval_secs":600},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Finish the iteraton with reboot","attrs":{"script":"write \"Finish the update iteraton with reboot\"","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Cleanup update task"},{"kind":"app_task","name":"Finish the iteraton without reboot"}],"name":"b12f0352_FAILURE_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Cleanup update task","attrs":{"script":"get-scheduledtask \"Patching\" -ea:4 | Unregister-scheduledtask -confirm:0","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Finish the iteraton without reboot","attrs":{"script":"write \"Finish the update iteraton without reboot\"","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Start 1 more iteration"}],"name":"cace7937_FAILURE_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Start 1 more iteration","attrs":{"script":"write-error \"We are not done yet, start 1 more iteration!\"","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"af3ba4cf_runbook","main_task_local_reference":{"kind":"app_task","name":"604c2941_dag"},"variable_list":[]},"client_attrs":{},"default_target_reference":{"kind":"app_endpoint","name":"SU-Windows2016"}},"name":"SU-Runbook-Windows-Patching"},"api_version":"3.0","metadata":{"last_update_time":"1627795151886732","kind":"runbook","spec_version":3,"creation_time":"1627789841972930","name":"SU-Runbook-Windows-Patching"}}